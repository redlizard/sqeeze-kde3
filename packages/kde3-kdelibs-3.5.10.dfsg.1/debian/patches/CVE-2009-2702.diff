#
# Description: Fix parsing of Subject Alternate Names in kssl (CVE-2009-2702)
# Patch: https://bugzilla.redhat.com/show_bug.cgi?id=520661
#
diff -Nur -x '*.orig' -x '*~' kdelibs-3.5.10.dfsg.1/kio/kssl/kopenssl.cc kdelibs-3.5.10.dfsg.1.new/kio/kssl/kopenssl.cc
--- kdelibs-3.5.10.dfsg.1/kio/kssl/kopenssl.cc	2006-07-22 03:16:39.000000000 -0500
+++ kdelibs-3.5.10.dfsg.1.new/kio/kssl/kopenssl.cc	2009-09-15 14:53:49.052000619 -0500
@@ -196,6 +196,7 @@
 static X509_NAME *(*K_X509_NAME_new)() = 0L;
 static int (*K_X509_REQ_set_subject_name)(X509_REQ*,X509_NAME*) = 0L;
 static unsigned char *(*K_ASN1_STRING_data)(ASN1_STRING*) = 0L;
+static int (*K_ASN1_STRING_length)(ASN1_STRING*) = 0L;
 static STACK_OF(SSL_CIPHER) *(*K_SSL_get_ciphers)(const SSL *ssl) = 0L;
 
 #endif
@@ -494,6 +495,7 @@
       K_X509_NAME_new = (X509_NAME *(*)()) _cryptoLib->symbol("X509_NAME_new");
       K_X509_REQ_set_subject_name = (int (*)(X509_REQ*,X509_NAME*)) _cryptoLib->symbol("X509_REQ_set_subject_name");
       K_ASN1_STRING_data = (unsigned char *(*)(ASN1_STRING*)) _cryptoLib->symbol("ASN1_STRING_data");
+      K_ASN1_STRING_length = (int (*)(ASN1_STRING*)) _cryptoLib->symbol("ASN1_STRING_length");
 #endif
    }
 
@@ -1545,6 +1547,13 @@
    return 0L;
 }
 
+
+int KOpenSSLProxy::ASN1_STRING_length(ASN1_STRING *x) {
+   if (K_ASN1_STRING_length) return (K_ASN1_STRING_length)(x);
+   return 0L;
+}
+
+
 STACK_OF(SSL_CIPHER) *KOpenSSLProxy::SSL_get_ciphers(const SSL* ssl) {
   if (K_SSL_get_ciphers) return (K_SSL_get_ciphers)(ssl);
   return 0L;
diff -Nur -x '*.orig' -x '*~' kdelibs-3.5.10.dfsg.1/kio/kssl/kopenssl.h kdelibs-3.5.10.dfsg.1.new/kio/kssl/kopenssl.h
--- kdelibs-3.5.10.dfsg.1/kio/kssl/kopenssl.h	2006-07-22 03:16:39.000000000 -0500
+++ kdelibs-3.5.10.dfsg.1.new/kio/kssl/kopenssl.h	2009-09-15 14:53:49.052000619 -0500
@@ -622,6 +622,11 @@
    unsigned char *ASN1_STRING_data(ASN1_STRING *x);
 
    /*
+    *  ASN1_STRING_length
+    */
+   int ASN1_STRING_length(ASN1_STRING *x);
+
+   /*
     *  
     */
    int OBJ_obj2nid(ASN1_OBJECT *o);
diff -Nur -x '*.orig' -x '*~' kdelibs-3.5.10.dfsg.1/kio/kssl/ksslcertificate.cc kdelibs-3.5.10.dfsg.1.new/kio/kssl/ksslcertificate.cc
--- kdelibs-3.5.10.dfsg.1/kio/kssl/ksslcertificate.cc	2006-01-19 11:06:12.000000000 -0600
+++ kdelibs-3.5.10.dfsg.1.new/kio/kssl/ksslcertificate.cc	2009-09-15 14:53:49.059994753 -0500
@@ -1099,7 +1099,9 @@
 		}
 
 		QString s = (const char *)d->kossl->ASN1_STRING_data(val->d.ia5);
-		if (!s.isEmpty()) {
+		if (!s.isEmpty()  &&
+				/* skip subjectAltNames with embedded NULs */
+				s.length() == d->kossl->ASN1_STRING_length(val->d.ia5)) {
 			rc += s;
 		}
 	}
